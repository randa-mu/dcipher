name: release-binaries
on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Enable test mode (creates draft release)'
        required: false
        type: boolean
        default: false

env:
  # If test_mode is true, or we're on a branch with a test-build- prefix then use a draft release
  TEST_MODE: ${{ github.event.inputs.test_mode == 'true' || startsWith(github.ref, 'refs/heads/test-build-') }}

jobs:
  build-binaries:
    uses: ./.github/workflows/build-all-binaries.yml
    secrets: inherit

  release:
    needs: build-binaries
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.test_mode == 'true' || startsWith(github.ref, 'refs/heads/test-build-')
    runs-on: ["randamu-self-hosted-default"]
    permissions:
      contents: write
    steps:
      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-${{ github.sha }}
          path: binaries

      - name: Download binaries metadata
        uses: actions/download-artifact@v4
        with:
          name: binaries-metadata-${{ github.sha }}
          path: .

      - name: Prepare binaries for release
        run: |
          # Extract all binary paths from binaries.json
          jq -rs 'map(.path) | join("\n")' binaries.json > binary-paths.txt

          echo "Binaries to release:"
          cat binary-paths.txt

          # Create a files list for the release action
          # The paths are relative to the binaries/ directory we downloaded to
          jq -rs 'map("binaries/" + (.path | split("/") | last)) | join("\n")' binaries.json > release-files.txt

          echo "Release file paths:"
          cat release-files.txt

      - name: Upload all binaries to release
        uses: softprops/action-gh-release@v2
        with:
          draft: ${{ env.TEST_MODE == 'true' }}
          generate_release_notes: true
          files: binaries/**
          fail_on_unmatched_files: true
