name: build-and-push-docker-images
on:
  push:
    branches:
      - "*"
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
  pull_request:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Enable test mode (uses candyland-test registry and draft releases)'
        required: false
        type: boolean
        default: true
      docker_push:
        description: 'Enable docker push'
        required: false
        type: boolean
        default: true
      release_push:
        description: 'Enable release push'
        required: false
        type: boolean
        default: true

env:
  # If test_mode is true, or we're on a branch with a test-build- prefix then use a test registry and a draft release
  TEST_MODE: ${{ github.event.inputs.test_mode == 'true' || startsWith(github.ref, 'refs/heads/test-build-') }}
  DOCKER_REGISTRY: ${{ (github.event.inputs.test_mode == 'true' || startsWith(github.ref, 'refs/heads/test-build-')) && 'europe-west1-docker.pkg.dev/randamu-prod/candyland-test' || 'europe-west1-docker.pkg.dev/randamu-prod/candyland' }}

  SERVICE_ACCOUNT: github@randamu-prod.iam.gserviceaccount.com
  IMAGE_MAINTAINER: "Randamu"
  IMAGE_VENDOR: "Randamu"
  AUTHOR: "Randu Mohammed"

jobs:
  build-binaries:
    uses: ./.github/workflows/build-all-binaries.yml
    secrets: inherit

  docker-build-all:
    name: "Build all Docker images"
    needs: build-binaries
    runs-on: ["randamu-self-hosted-default"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download binaries metadata
        uses: actions/download-artifact@v4
        with:
          name: binaries-metadata-${{ github.sha }}
          path: .

      - name: Upload Docker build context
        uses: actions/upload-artifact@v4
        with:
          name: docker-context-${{ github.sha }}
          path: |
            Dockerfile
            .github/docker-config.json
            .dockerignore
          retention-days: 1
          overwrite: true
      - name: Download pre-built binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-${{ github.sha }}
          path: target/release
      - name: Login to Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: europe-west1-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.GCP_SERVICE_ACCOUNT_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # this might not work at all, but might work and
          # allow us to bypass dockerhub ratelimit
          buildkitd-config-inline: |
            [registry."docker.io"]
              mirrors = ["mirror.gcr.io"]
          ## this does work to avoid the dockerhub ratelimit
          driver-opts: |
            image=mirror.gcr.io/moby/buildkit:buildx-stable-1
            network=host

      - name: Build and push all Docker images
        env:
          GITHUB_REF: ${{ github.ref }}
          GITHUB_SHA: ${{ github.sha }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          TEST_MODE: ${{ env.TEST_MODE }}
          DOCKER_REGISTRY: ${{ env.DOCKER_REGISTRY }}
          IMAGE_MAINTAINER: ${{ env.IMAGE_MAINTAINER }}
          IMAGE_VENDOR: ${{ env.IMAGE_VENDOR }}
        run: |
          chmod +x .github/build-docker.sh
          ./.github/build-docker.sh

      - name: Upload workspace for debugging
        uses: actions/upload-artifact@v4
        with:
          name: workspace-debug
          path: .
          retention-days: 1
        if: ${{
            (github.event.inputs.test_mode == 'true' || startsWith(github.ref, 'refs/heads/test-build-')) &&
            success() || failure()
          }}
